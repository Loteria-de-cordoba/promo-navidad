<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Compra - El Centro est√° de Fiesta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            min-height: 100vh;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(30, 58, 138, 0.3);
        }

        .input-field {
            transition: all 0.3s ease;
        }

        .input-field:focus {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-submit {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            transition: all 0.3s ease;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(220, 38, 38, 0.5);
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .success-box {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        }

        .error-box {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .section-border {
            border-color: #3b82f6;
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <div class="max-w-3xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8 fade-in">
            <div class="mb-4 flex justify-center">
                <img src="assets/LDC Logotipo COLOR Horizontal 300dpi.png" alt="Loteria de C√≥rdoba"
                    class="h-20 md:h-24">
            </div>
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">EL CENTRO EST√Å DE FIESTA</h1>
            <p class="text-white text-lg opacity-90">Complet√° tus datos y particip√° del sorteo</p>
        </div>

        <!-- Form Container -->
        <div class="glass-effect rounded-2xl p-6 md:p-8 mb-6 fade-in">
            <form id="purchaseForm">
                <!-- Datos de la Agencia -->
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-blue-900 mb-4 pb-2 border-b-2 section-border">
                        üè™ Datos de la Agencia
                    </h2>

                    <div class="space-y-4">
                        <div>
                            <label for="ocr" class="block text-sm font-semibold text-gray-700 mb-2">
                                N√∫mero OCR *
                            </label>
                            <input type="text" id="ocr" name="ocr" required placeholder="1234567890123456"
                                pattern="[0-9]{16}" maxlength="16"
                                class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" />
                            <p class="text-xs text-gray-500 mt-1">16 d√≠gitos</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="nroSucursal" class="block text-sm font-semibold text-gray-700 mb-2">
                                    N√∫mero de Sucursal *
                                </label>
                                <input type="text" id="nroSucursal" name="nroSucursal" required placeholder="01"
                                    pattern="[0-9]{2}" maxlength="2"
                                    class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" />
                                <p class="text-xs text-gray-500 mt-1">2 d√≠gitos</p>
                            </div>

                            <div>
                                <label for="nroAgencia" class="block text-sm font-semibold text-gray-700 mb-2">
                                    N√∫mero de Agencia *
                                </label>
                                <input type="text" id="nroAgencia" name="nroAgencia" required placeholder="12345"
                                    pattern="[0-9]{5}" maxlength="5"
                                    class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" />
                                <p class="text-xs text-gray-500 mt-1">5 d√≠gitos</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Datos de la Compra -->
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-blue-900 mb-4 pb-2 border-b-2 section-border">
                        üõí Informaci√≥n de tu Compra
                    </h2>

                    <div class="space-y-4">
                        <div>
                            <label for="cuitLocal" class="block text-sm font-semibold text-gray-700 mb-2">
                                CUIT del Comercio *
                            </label>
                            <input type="text" id="cuitLocal" name="cuitLocal" required placeholder="20-12345678-9"
                                pattern="[0-9]{2}-[0-9]{8}-[0-9]{1}" maxlength="13"
                                class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" />
                            <p class="text-xs text-gray-500 mt-1">Formato: XX-XXXXXXXX-X</p>
                        </div>

                        <div>
                            <label for="nroComprobante" class="block text-sm font-semibold text-gray-700 mb-2">
                                N√∫mero de Ticket o Factura *
                            </label>
                            <input type="text" id="nroComprobante" name="nroComprobante" required
                                placeholder="0001-00000001" pattern="[0-9]{4}-[0-9]{8}" maxlength="13"
                                class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" />
                            <p class="text-xs text-gray-500 mt-1">Formato: XXXX-XXXXXXXX (4 d√≠gitos - 8 d√≠gitos)</p>
                        </div>

                        <div>
                            <label for="monto" class="block text-sm font-semibold text-gray-700 mb-2">
                                Monto Total de la Compra *
                            </label>
                            <div class="relative">
                                <span class="absolute left-4 top-3 text-gray-600 font-semibold">$</span>
                                <input type="number" id="monto" name="monto" required min="30000" step="0.01"
                                    placeholder="30000"
                                    class="input-field w-full pl-8 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" />
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Monto m√≠nimo para participar: $30.000</p>
                        </div>

                        <div>
                            <label for="ticket" class="block text-sm font-semibold text-gray-700 mb-2">
                                Foto del Ticket o Factura *
                            </label>
                            <div class="relative">
                                <input type="file" id="ticket" name="ticket" required accept="image/*" class="hidden"
                                    onchange="updateFileName(this)" />
                                <label for="ticket"
                                    class="input-field cursor-pointer flex items-center justify-center w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50">
                                    <svg class="w-6 h-6 text-gray-400 mr-2" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                    <span id="fileName" class="text-gray-600">Hac√© clic para subir tu
                                        comprobante...</span>
                                </label>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Aceptamos JPG, PNG o WebP</p>
                        </div>
                    </div>
                </div>

                <!-- Datos del Comprador -->
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-blue-900 mb-4 pb-2 border-b-2 section-border">
                        üë§ Tus Datos Personales
                    </h2>

                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="nombre" class="block text-sm font-semibold text-gray-700 mb-2">
                                    Nombre *
                                </label>
                                <input type="text" id="nombre" name="nombre" required placeholder="Juan"
                                    class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" />
                            </div>

                            <div>
                                <label for="apellido" class="block text-sm font-semibold text-gray-700 mb-2">
                                    Apellido *
                                </label>
                                <input type="text" id="apellido" name="apellido" required placeholder="P√©rez"
                                    class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" />
                            </div>
                        </div>

                        <div>
                            <label for="dni" class="block text-sm font-semibold text-gray-700 mb-2">
                                N√∫mero de DNI *
                            </label>
                            <input type="text" id="dni" name="dni" required placeholder="12345678" pattern="[0-9]{7,8}"
                                class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" />
                            <p class="text-xs text-gray-500 mt-1">Solo n√∫meros, sin puntos ni espacios</p>
                        </div>

                        <div>
                            <label for="fechaNacimiento" class="block text-sm font-semibold text-gray-700 mb-2">
                                Fecha de Nacimiento *
                            </label>
                            <input type="date" id="fechaNacimiento" name="fechaNacimiento" required
                                class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" />
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="md:col-span-1">
                                <label for="codigoArea" class="block text-sm font-semibold text-gray-700 mb-2">
                                    C√≥digo de √Årea *
                                </label>
                                <input type="text" id="codigoArea" name="codigoArea" required placeholder="351"
                                    pattern="[0-9]{2,4}" maxlength="4"
                                    class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" />
                                <p class="text-xs text-gray-500 mt-1">Ej: 351</p>
                            </div>

                            <div class="md:col-span-2">
                                <label for="telefono" class="block text-sm font-semibold text-gray-700 mb-2">
                                    N√∫mero de Tel√©fono *
                                </label>
                                <input type="text" id="telefono" name="telefono" required placeholder="1234567"
                                    pattern="[0-9]{6,8}" maxlength="8"
                                    class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" />
                                <p class="text-xs text-gray-500 mt-1">Sin el 15 ni guiones</p>
                            </div>
                        </div>

                        <div>
                            <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
                                Correo Electr√≥nico *
                            </label>
                            <input type="email" id="email" name="email" required placeholder="tucorreo@ejemplo.com"
                                class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" />
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="submitBtn"
                    class="btn-submit w-full text-white font-bold py-4 px-6 rounded-lg text-lg">
                    üéâ Enviar mi Participaci√≥n
                </button>
            </form>
        </div>

        <!-- Response Container -->
        <div id="responseContainer" class="hidden fade-in"></div>
    </div>

    <script>
        // Update file name display
        function updateFileName(input) {
            const fileName = input.files[0]?.name || 'Hac√© clic para subir tu comprobante...';
            document.getElementById('fileName').textContent = fileName;
        }

        // Format CUIT del Local automatically
        document.getElementById('cuitLocal').addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, ''); // Remove non-digits

            if (value.length > 11) {
                value = value.substring(0, 11);
            }

            let formatted = '';
            if (value.length > 0) {
                formatted = value.substring(0, 2);
                if (value.length > 2) {
                    formatted += '-' + value.substring(2, 10);
                    if (value.length > 10) {
                        formatted += '-' + value.substring(10, 11);
                    }
                }
            }

            e.target.value = formatted;
        });

        // Format N√∫mero de Comprobante automatically
        document.getElementById('nroComprobante').addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, ''); // Remove non-digits

            if (value.length > 12) {
                value = value.substring(0, 12);
            }

            let formatted = '';
            if (value.length > 0) {
                formatted = value.substring(0, 4);
                if (value.length > 4) {
                    formatted += '-' + value.substring(4, 12);
                }
            }

            e.target.value = formatted;
        });

        // Only allow numbers in numeric fields
        ['ocr', 'nroSucursal', 'nroAgencia', 'dni', 'codigoArea', 'telefono'].forEach(id => {
            document.getElementById(id).addEventListener('input', function (e) {
                e.target.value = e.target.value.replace(/\D/g, '');
            });
        });

        // Handle form submission
        document.getElementById('purchaseForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const responseContainer = document.getElementById('responseContainer');

            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Enviando...<div class="spinner"></div>';
            responseContainer.classList.add('hidden');

            try {
                // Get form data
                const formData = new FormData();

                // Add all form fields
                formData.append('ocr', document.getElementById('ocr').value);
                formData.append('nroSucursal', document.getElementById('nroSucursal').value);
                formData.append('nroAgencia', document.getElementById('nroAgencia').value);
                formData.append('cuitLocal', document.getElementById('cuitLocal').value);
                formData.append('nroComprobante', document.getElementById('nroComprobante').value);
                formData.append('monto', document.getElementById('monto').value);
                formData.append('nombre', document.getElementById('nombre').value);
                formData.append('apellido', document.getElementById('apellido').value);
                formData.append('dni', document.getElementById('dni').value);
                formData.append('fechaNacimiento', document.getElementById('fechaNacimiento').value);
                formData.append('codigoArea', document.getElementById('codigoArea').value);
                formData.append('telefono', document.getElementById('telefono').value);
                formData.append('email', document.getElementById('email').value);

                // Handle file upload - convert to base64
                const fileInput = document.getElementById('ticket');
                const file = fileInput.files[0];

                if (file) {
                    const base64 = await fileToBase64(file);
                    formData.append('ticketBase64', base64);
                    formData.append('ticketFileName', file.name);
                    formData.append('ticketContentType', file.type);
                }

                // Convert FormData to JSON for Power Automate
                const jsonData = {};
                for (let [key, value] of formData.entries()) {
                    jsonData[key] = value;
                }

                // Send to Power Automate
                const response = await fetch('https://default4ff172a4c9ce49b0b39d8f0bd292c0.42.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/086daf758a8b42739f70ac64a995c20a/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=IQB14siZevuLtO31WjZyvy4bove60j0oYJckZpLXFUM', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(jsonData)
                });

                // Handle response
                let result;
                const contentType = response.headers.get('content-type');

                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    result = await response.text();
                }

                // Show success message
                showResponse(true, result, response.status);

                // Reset form on success
                if (response.ok) {
                    document.getElementById('purchaseForm').reset();
                    document.getElementById('fileName').textContent = 'Hac√© clic para subir tu comprobante...';
                }

            } catch (error) {
                console.error('Error:', error);
                showResponse(false, error.message);
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'üéâ Enviar mi Participaci√≥n';
            }
        });

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    // Remove the data:image/xxx;base64, prefix
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }

        // Show response message
        function showResponse(success, data, statusCode) {
            const responseContainer = document.getElementById('responseContainer');
            const bgClass = success ? 'success-box' : 'error-box';
            const icon = success ? '‚úÖ' : '‚ùå';
            const title = success ? '¬°Tu participaci√≥n fue registrada!' : 'Hubo un problema';

            let dataDisplay = '';
            if (typeof data === 'object') {
                dataDisplay = `<pre class="bg-white bg-opacity-30 p-4 rounded-lg overflow-auto text-sm mt-4">${JSON.stringify(data, null, 2)}</pre>`;
            } else {
                dataDisplay = `<p class="mt-4 text-white">${data}</p>`;
            }

            responseContainer.innerHTML = `
                <div class="${bgClass} rounded-2xl p-6 md:p-8 text-center">
                    <div class="text-6xl mb-4">${icon}</div>
                    <h3 class="text-2xl font-bold text-white mb-2">${title}</h3>
                    ${statusCode ? `<p class="text-white opacity-90 mb-2">C√≥digo de respuesta: ${statusCode}</p>` : ''}
                    ${dataDisplay}
                    ${success ? '<p class="text-white mt-4 text-lg">¬°Muchas gracias por participar! Te contactaremos en caso de resultar ganador/a.</p>' : '<p class="text-white mt-4">Por favor, revis√° los datos e intent√° nuevamente.</p>'}
                </div>
            `;

            responseContainer.classList.remove('hidden');
            responseContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    </script>
</body>

</html>