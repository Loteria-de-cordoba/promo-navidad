<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registros Verificados - El Centro est√° de Fiesta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            min-height: 100vh;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        .toggle-checkbox:checked {
            right: 0;
            border-color: #10b981;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #10b981;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modal Styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>

<body class="p-4 md:p-8 font-sans text-gray-800">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-lg">
            <div class="flex items-center gap-4 mb-4 md:mb-0">
                <div class="bg-green-100 p-3 rounded-full">
                    <span class="text-4xl">‚úÖ</span>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Registros Verificados</h1>
                    <p class="text-gray-500 text-sm">Panel de control de validaci√≥n</p>
                </div>
            </div>

            <!-- Toggle Switch -->
            <div class="flex items-center bg-gray-100 p-1.5 rounded-xl">
                <button id="btnAgencia" onclick="setMode('agencia')"
                    class="px-6 py-2 rounded-lg text-sm font-semibold transition-all shadow-sm bg-white text-green-700">
                    üè™ Agencias
                </button>
                <button id="btnComercio" onclick="setMode('comercio')"
                    class="px-6 py-2 rounded-lg text-sm font-semibold text-gray-500 hover:text-gray-700 transition-all">
                    üõí Comercios
                </button>
            </div>
        </div>

        <!-- Content Area -->
        <div class="glass-effect rounded-2xl p-6 md:p-8 min-h-[500px]">
            <!-- Loading State -->
            <div id="loading" class="hidden flex justify-center items-center h-64">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600"></div>
            </div>

            <!-- Table Container -->
            <div id="tableContainer" class="overflow-x-auto fade-in">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-gray-500 border-b border-gray-200 text-sm uppercase tracking-wider">
                            <!-- Headers will be injected here -->
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="text-sm">
                        <!-- Rows will be injected here -->
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden flex flex-col items-center justify-center h-64 text-gray-400">
                <span class="text-5xl mb-4">üì≠</span>
                <p class="text-lg">No se encontraron registros para esta categor√≠a.</p>
            </div>

            <!-- Pagination Controls -->
            <div id="paginationControls" class="hidden flex justify-center items-center mt-6 gap-4 fade-in">
                <button id="btnPrev" onclick="changePage(-1)"
                    class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-gray-700">
                    ‚¨ÖÔ∏è Anterior
                </button>
                <span id="pageIndicator"
                    class="text-sm font-semibold text-gray-700 bg-white px-4 py-2 rounded-lg border border-gray-200">
                    P√°gina 1
                </span>
                <button id="btnNext" onclick="changePage(1)"
                    class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-gray-700">
                    Siguiente ‚û°Ô∏è
                </button>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal"
        class="hidden fixed inset-0 z-50 overflow-y-auto modal-overlay flex justify-center items-center p-4">
        <div
            class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform transition-all scale-100">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-6 border-b border-gray-100">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    üìÑ Detalle del Comprobante
                </h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto flex-1">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Info Section -->
                    <div class="space-y-4">
                        <div class="bg-gray-50 p-4 rounded-xl space-y-3">
                            <h4 class="font-semibold text-gray-700 border-b border-gray-200 pb-2 mb-2">Informaci√≥n del
                                Comercio</h4>
                            <div>
                                <span class="text-xs font-bold text-gray-500 uppercase">Empresa/Comercio</span>
                                <p id="modalEmpresa" class="text-lg font-medium text-gray-900">-</p>
                            </div>
                            <div>
                                <span class="text-xs font-bold text-gray-500 uppercase">CUIT</span>
                                <p id="modalCuit" class="text-base text-gray-700 font-mono">-</p>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-xl space-y-3">
                            <h4 class="font-semibold text-blue-800 border-b border-blue-200 pb-2 mb-2">Detalles de la
                                Compra</h4>
                            <div>
                                <span class="text-xs font-bold text-blue-600 uppercase">Nro. Comprobante</span>
                                <p id="modalTicket" class="text-base text-gray-900 font-mono">-</p>
                            </div>
                            <div class="flex justify-between">
                                <div>
                                    <span class="text-xs font-bold text-blue-600 uppercase">Fecha</span>
                                    <p id="modalFecha" class="text-base text-gray-900">-</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs font-bold text-blue-600 uppercase">Monto Total</span>
                                    <p id="modalMonto" class="text-xl font-bold text-green-600">-</p>
                                </div>
                            </div>
                            <div>
                                <span class="text-xs font-bold text-blue-600 uppercase">Medio de Pago</span>
                                <p id="modalPago" class="text-base text-gray-900">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Image Section -->
                    <div class="flex flex-col h-full">
                        <h4 class="font-semibold text-gray-700 mb-3">üì∏ Imagen del Comprobante</h4>
                        <div
                            class="flex-1 bg-gray-100 rounded-xl border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden min-h-[300px] relative">
                            <!-- Image Container -->
                            <img id="modalImage" class="hidden w-full h-full object-contain" alt="Ticket" />

                            <!-- Loading Spinner for Image -->
                            <div id="imageLoading" class="hidden flex flex-col items-center">
                                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-2"></div>
                                <span class="text-sm text-gray-500">Cargando imagen...</span>
                            </div>

                            <!-- No Image Placeholder -->
                            <div id="noImage" class="hidden flex flex-col items-center text-gray-400">
                                <span class="text-4xl mb-2">üñºÔ∏è</span>
                                <span class="text-sm">Sin imagen disponible</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-100 bg-gray-50 rounded-b-2xl flex justify-end gap-3">
                <button onclick="closeModal()"
                    class="px-5 py-2.5 bg-white border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition-colors">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Mock Data for Agencies
        const agenciasData = [
            {
                "id_apuesta": "550e8400-e29b-41d4-a716-446655440000",
                "id_persona": "d497461c-67f0-44e5-80b1-02d30ba45735",
                "nro_agencia": "1234",
                "nro_sucursal": "01",
                "ocr": "1234567890123456",
                "monto_apuesta": 5000.0,
                "fecha_creacion": "2025-12-16T12:00:00.000000Z",
                "validado": "S",
                "verificado": "N"
            },
            {
                "id_apuesta": "770e8400-e29b-41d4-a716-996655441122",
                "id_persona": "a1b2c3d4-67f0-44e5-80b1-998877665544",
                "nro_agencia": "5678",
                "nro_sucursal": "02",
                "ocr": "9876543210987654",
                "monto_apuesta": 12500.0,
                "fecha_creacion": "2025-12-16T15:45:00.000000Z",
                "validado": "N",
                "verificado": "N"
            }
        ];

        let comerciosData = [];
        let currentPage = 1;
        let isLoading = false;
        let currentMode = 'agencia';

        // Main Data API
        const API_URL = "https://default4ff172a4c9ce49b0b39d8f0bd292c0.42.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/f41ef9a7ac214c0a9d6da26a1d087ba0/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=CLCm0Hot5ySPWwKLIvgEGDtvz2Jp_YqnYn40K6OJitE";

        // Image API Placeholder (To be replaced with real endpoint)
        const IMAGE_API_URL = "https://placeholder-api-url.com/get-image";

        async function setMode(mode) {
            currentMode = mode;

            // Update Buttons
            const btnAgencia = document.getElementById('btnAgencia');
            const btnComercio = document.getElementById('btnComercio');
            const paginationControls = document.getElementById('paginationControls');

            if (mode === 'agencia') {
                btnAgencia.className = "px-6 py-2 rounded-lg text-sm font-semibold transition-all shadow-sm bg-white text-green-700";
                btnComercio.className = "px-6 py-2 rounded-lg text-sm font-semibold text-gray-500 hover:text-gray-700 transition-all";
                paginationControls.classList.add('hidden');

                // Ensure UI is cleanly reset
                renderTable();
            } else {
                btnComercio.className = "px-6 py-2 rounded-lg text-sm font-semibold transition-all shadow-sm bg-white text-blue-700";
                btnAgencia.className = "px-6 py-2 rounded-lg text-sm font-semibold text-gray-500 hover:text-gray-700 transition-all";
                paginationControls.classList.remove('hidden');

                // If we don't have data for this page yet, load it. 
                if (comerciosData.length === 0) {
                    await loadComercios(currentPage);
                } else {
                    renderTable();
                }
            }
        }

        async function loadComercios(page) {
            isLoading = true;
            updateUIState();

            try {
                const response = await fetch(`${API_URL}&page=${page}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                comerciosData = Array.isArray(data) ? data : (data.value || []);

            } catch (error) {
                console.error("Error loading data:", error);
                comerciosData = [];
                alert("Hubo un error al cargar los datos de comercio.");
            } finally {
                isLoading = false;
                updateUIState();
                renderTable();
            }
        }

        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage < 1) return;

            currentPage = newPage;
            loadComercios(currentPage);
        }

        function updateUIState() {
            const loading = document.getElementById('loading');
            const tableContainer = document.getElementById('tableContainer');
            const emptyState = document.getElementById('emptyState');
            const btnPrev = document.getElementById('btnPrev');
            const pageIndicator = document.getElementById('pageIndicator');
            const btnNext = document.getElementById('btnNext');

            pageIndicator.innerText = `P√°gina ${currentPage}`;
            btnPrev.disabled = currentPage <= 1 || isLoading;

            const hasMore = comerciosData.length === 10;
            btnNext.disabled = isLoading || !hasMore;

            if (isLoading) {
                loading.classList.remove('hidden');
                tableContainer.classList.add('hidden');
                emptyState.classList.add('hidden');
            } else {
                loading.classList.add('hidden');
            }
        }

        function renderTable() {
            if (isLoading) return;

            const container = document.getElementById('tableContainer');
            const tbody = document.getElementById('tableBody');
            const theadRow = document.querySelector('thead tr');
            const emptyState = document.getElementById('emptyState');

            // Clear current content
            tbody.innerHTML = '';
            theadRow.innerHTML = '';

            const data = currentMode === 'agencia' ? agenciasData : comerciosData;

            if (!data || data.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            } else {
                container.classList.remove('hidden');
                emptyState.classList.add('hidden');
            }

            // Define columns
            let columns = [];

            if (currentMode === 'agencia') {
                columns = [
                    { key: 'fecha_creacion', label: 'Fecha', format: val => formatDate(val) },
                    { key: 'nro_agencia', label: 'Agencia' },
                    { key: 'ocr', label: 'OCR' },
                    { key: 'monto_apuesta', label: 'Monto', format: val => `$${val?.toLocaleString('es-AR')}` },
                    { key: 'validado', label: 'Validado', format: renderStatusBadge },
                    { key: 'verificado', label: 'Verificado', format: renderStatusBadge }
                ];
            } else {
                columns = [
                    { key: 'fecha_creacion', label: 'Fecha', format: val => formatDate(val) },
                    { key: 'descripcion_empresa', label: 'Empresa' },
                    { key: 'cuit_comercio', label: 'CUIT' },
                    { key: 'numero_ticket_factura', label: 'Comprobante' },
                    { key: 'monto_total_compra', label: 'Monto', format: val => `$${val?.toLocaleString('es-AR')}` },
                    //{ key: 'medio_pago', label: 'Pago', format: val => val === 'bancor' ? 'üí≥ Bancor' : 'üí∞ Otros' },
                    { key: 'validado', label: 'Validado', format: renderStatusBadge },
                    // { key: 'verificado', label: 'Verificado', format: renderStatusBadge },
                    { key: 'actions', label: 'Acciones', format: (val, item) => renderActions(item) }
                ];
            }

            // Render Headers
            columns.forEach(col => {
                const th = document.createElement('th');
                th.className = "pb-3 pl-4 font-semibold text-gray-600";
                th.innerText = col.label;
                theadRow.appendChild(th);
            });

            // Render Rows
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-50 hover:bg-white transition-colors bg-white/50";

                columns.forEach(col => {
                    const td = document.createElement('td');
                    td.className = "py-4 pl-4 text-gray-700 align-middle";

                    if (col.key === 'actions') {
                        td.innerHTML = col.format(null, item);
                    } else {
                        const value = item[col.key];
                        td.innerHTML = col.format ? col.format(value, item) : (value || '-');
                    }

                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
        }

        function renderActions(item) {
            // Store the item data in a data attribute (serialized) or just use the button with an onclick passing the ID
            // Since passing the whole object in HTML string is messy, we'll store it in a global array or search by ID.
            // Here we'll just pass the ID to openModal and find it.
            const id = item.id_compra; // Assuming id_compra is unique for comercio
            return `
                <button onclick="openModal('${id}')" class="group flex items-center gap-1.5 px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-600 hover:text-white transition-all text-xs font-semibold border border-blue-200 hover:border-blue-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    Ver Detalle
                </button>
             `;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return dateString;
            }
        }

        function renderStatusBadge(status) {
            if (status === 'S' || status === 'YES' || status === true) {
                return '<span class="px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800 border border-green-200">S√ç</span>';
            } else {
                return '<span class="px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-800 border border-red-200">NO</span>';
            }
        }

        // --- Modal Logic ---

        function openModal(id) {
            const item = comerciosData.find(d => d.id_compra === id);
            if (!item) return;

            // Populate Text Fields
            document.getElementById('modalEmpresa').textContent = item.descripcion_empresa || '-';
            document.getElementById('modalCuit').textContent = item.cuit_comercio || '-';
            document.getElementById('modalTicket').textContent = item.numero_ticket_factura || '-';
            document.getElementById('modalFecha').textContent = formatDate(item.fecha_creacion);
            document.getElementById('modalMonto').textContent = item.monto_total_compra ? `$${item.monto_total_compra.toLocaleString('es-AR')}` : '-';
            const pagoText = item.medio_pago === 'bancor' ? 'üí≥ Bancor' : (item.medio_pago === 'otros' ? 'üí∞ Otros' : item.medio_pago || '-');
            document.getElementById('modalPago').textContent = pagoText;

            // Image Handling
            const imgElement = document.getElementById('modalImage');
            const loadingElement = document.getElementById('imageLoading');
            const noImageElement = document.getElementById('noImage');

            // Reset State
            imgElement.classList.add('hidden');
            imgElement.src = '';
            loadingElement.classList.add('hidden');
            noImageElement.classList.add('hidden');

            // Start Fetching Image
            fetchImage(id);

            // Show Modal
            const modal = document.getElementById('detailsModal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
        }

        async function fetchImage(id) {
            const imgElement = document.getElementById('modalImage');
            const loadingElement = document.getElementById('imageLoading');
            const noImageElement = document.getElementById('noImage');

            loadingElement.classList.remove('hidden');

            try {
                // TODO: Replace with real endpoint call.
                // Assuming POST or GET to get base64
                // const response = await fetch(`${IMAGE_API_URL}?id=${id}`);
                // const data = await response.json();

                // For demonstration, simulating network request and mock response if no real URL provided
                await new Promise(r => setTimeout(r, 1000));

                // Mock logic: randomly succeed or fail for demo
                // In real implementation: if (data.base64) ...

                const hasImage = false; // Set to true when real endpoint available or for demo

                if (hasImage) {
                    // imgElement.src = `data:image/jpeg;base64,${data.base64Content}`;
                    // imgElement.classList.remove('hidden');
                } else {
                    // For now showing "No Image" since we don't have the real endpoint yet
                    noImageElement.classList.remove('hidden');
                    console.log("Fetching image for ID:", id, "- Placeholder logic: No endpoint connected.");
                }

            } catch (error) {
                console.error("Error fetching image:", error);
                noImageElement.classList.remove('hidden');
            } finally {
                loadingElement.classList.add('hidden');
            }
        }

        function closeModal() {
            const modal = document.getElementById('detailsModal');
            modal.classList.add('hidden');
            document.body.style.overflow = ''; // Restore scrolling
        }

        // Close on clicking overlay
        document.getElementById('detailsModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setMode('agencia');
        });

    </script>
</body>

</html>