<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registros Verificados - El Centro est√° de Fiesta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            min-height: 100vh;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>

<body class="p-4 md:p-8 font-sans text-gray-800">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-lg">
            <div class="flex items-center gap-4 mb-4 md:mb-0">
                <div class="bg-green-100 p-3 rounded-full">
                    <span class="text-4xl">‚úÖ</span>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Registros Verificados</h1>
                    <p class="text-gray-500 text-sm">Panel de control de validaci√≥n</p>
                </div>
            </div>

            <!-- Toggle Switch -->
            <div class="flex items-center bg-gray-100 p-1.5 rounded-xl">
                <button id="btnAgencia" onclick="setMode('agencia')"
                    class="px-6 py-2 rounded-lg text-sm font-semibold transition-all shadow-sm bg-white text-green-700">
                    üè™ Agencias
                </button>
                <button id="btnComercio" onclick="setMode('comercio')"
                    class="px-6 py-2 rounded-lg text-sm font-semibold text-gray-500 hover:text-gray-700 transition-all">
                    üõí Comercios
                </button>
            </div>
        </div>

        <!-- Content Area -->
        <div class="glass-effect rounded-2xl p-6 md:p-8 min-h-[500px]">
            <!-- Loading State -->
            <div id="loading" class="hidden flex justify-center items-center h-64">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600"></div>
            </div>

            <!-- Table Container -->
            <div id="tableContainer" class="overflow-x-auto fade-in">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-gray-500 border-b border-gray-200 text-sm uppercase tracking-wider">
                            <!-- Headers will be injected here -->
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="text-sm">
                        <!-- Rows will be injected here -->
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden flex flex-col items-center justify-center h-64 text-gray-400">
                <span class="text-5xl mb-4">üì≠</span>
                <p class="text-lg">No se encontraron registros para esta categor√≠a.</p>
            </div>

            <!-- Pagination Controls -->
            <div id="paginationControls" class="hidden flex justify-center items-center mt-6 gap-4 fade-in">
                <button id="btnPrev" onclick="changePage(-1)"
                    class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-gray-700">
                    ‚¨ÖÔ∏è Anterior
                </button>
                <span id="pageIndicator"
                    class="text-sm font-semibold text-gray-700 bg-white px-4 py-2 rounded-lg border border-gray-200">
                    P√°gina 1
                </span>
                <button id="btnNext" onclick="changePage(1)"
                    class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-gray-700">
                    Siguiente ‚û°Ô∏è
                </button>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal"
        class="hidden fixed inset-0 z-50 overflow-y-auto modal-overlay flex justify-center items-center p-4">
        <div
            class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform transition-all scale-100">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-6 border-b border-gray-100">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    üìÑ Detalle del Comprobante
                </h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto flex-1">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Info Section -->
                    <div class="space-y-4">

                        <!-- Comercio Fields -->
                        <div id="comercioFields" class="bg-gray-50 p-4 rounded-xl space-y-3 hidden">
                            <h4 class="font-semibold text-gray-700 border-b border-gray-200 pb-2 mb-2">Informaci√≥n del
                                Comercio</h4>
                            <div>
                                <span class="text-xs font-bold text-gray-500 uppercase">Empresa/Comercio</span>
                                <p id="modalEmpresa" class="text-lg font-medium text-gray-900">-</p>
                            </div>
                            <div>
                                <span class="text-xs font-bold text-gray-500 uppercase">CUIT</span>
                                <p id="modalCuit" class="text-base text-gray-700 font-mono">-</p>
                            </div>
                        </div>

                        <!-- Agencia Fields -->
                        <div id="agenciaFields" class="bg-purple-50 p-4 rounded-xl space-y-3 hidden">
                            <h4 class="font-semibold text-purple-800 border-b border-purple-200 pb-2 mb-2">Informaci√≥n
                                de Agencia</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <span class="text-xs font-bold text-purple-600 uppercase">Nro. Agencia</span>
                                    <p id="modalNroAgencia" class="text-lg font-medium text-gray-900 font-mono">-</p>
                                </div>
                                <div>
                                    <span class="text-xs font-bold text-purple-600 uppercase">Sucursal</span>
                                    <p id="modalSucursal" class="text-lg font-medium text-gray-900 font-mono">-</p>
                                </div>
                            </div>
                            <div>
                                <span class="text-xs font-bold text-purple-600 uppercase">OCR</span>
                                <p id="modalOCR" class="text-base text-gray-700 font-mono break-all">-</p>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-xl space-y-3">
                            <h4 class="font-semibold text-blue-800 border-b border-blue-200 pb-2 mb-2">Detalles de la
                                Transacci√≥n</h4>
                            <!-- Common Fields -->
                            <div id="fieldTicket" class="hidden">
                                <span class="text-xs font-bold text-blue-600 uppercase">Nro. Comprobante</span>
                                <p id="modalTicket" class="text-base text-gray-900 font-mono">-</p>
                            </div>
                            <div class="flex justify-between">
                                <div>
                                    <span class="text-xs font-bold text-blue-600 uppercase">Fecha</span>
                                    <p id="modalFecha" class="text-base text-gray-900">-</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs font-bold text-blue-600 uppercase">Monto Total</span>
                                    <p id="modalMonto" class="text-xl font-bold text-green-600">-</p>
                                </div>
                            </div>
                            <div id="fieldPago" class="hidden">
                                <span class="text-xs font-bold text-blue-600 uppercase">Medio de Pago</span>
                                <p id="modalPago" class="text-base text-gray-900">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Image Section -->
                    <div class="flex flex-col h-full">
                        <h4 class="font-semibold text-gray-700 mb-3">üì∏ Imagen del Comprobante</h4>
                        <div
                            class="flex-1 bg-gray-100 rounded-xl border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden min-h-[300px] relative">
                            <!-- Image Container -->
                            <img id="modalImage" class="hidden w-full h-full object-contain" alt="Ticket" />

                            <!-- Loading Spinner for Image -->
                            <div id="imageLoading" class="hidden flex flex-col items-center">
                                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-2"></div>
                                <span class="text-sm text-gray-500">Cargando imagen...</span>
                            </div>

                            <!-- No Image Placeholder -->
                            <div id="noImage" class="hidden flex flex-col items-center text-gray-400">
                                <span class="text-4xl mb-2">üñºÔ∏è</span>
                                <span class="text-sm">Sin imagen disponible</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-100 bg-gray-50 rounded-b-2xl flex justify-between items-center gap-3">
                <div class="flex gap-3">
                    <button onclick="anularRecord()"
                        class="px-5 py-2.5 bg-red-50 text-red-600 border border-red-200 font-semibold rounded-lg hover:bg-red-100 transition-colors">
                        üö´ Anular
                    </button>
                    <button onclick="validateRecord()"
                        class="px-5 py-2.5 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors shadow-sm">
                        ‚úÖ Validar
                    </button>
                </div>
                <button onclick="closeModal()"
                    class="px-5 py-2.5 bg-white border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition-colors">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <script>
        // API URLs
        const API_URL_COMERCIO = "https://default4ff172a4c9ce49b0b39d8f0bd292c0.42.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/f41ef9a7ac214c0a9d6da26a1d087ba0/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=CLCm0Hot5ySPWwKLIvgEGDtvz2Jp_YqnYn40K6OJitE";
        const API_URL_AGENCIA = "https://default4ff172a4c9ce49b0b39d8f0bd292c0.42.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/9c3f60f9dd2241139c8c8419790c5648/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=zU1en4X8GegkCoEKGAjXqdbEdDo-xHnVK2p8OUyUul0";

        // State
        let currentMode = 'agencia'; // 'agencia' or 'comercio'
        let currentPage = 1;
        let recordsData = [];
        let isLoading = false;
        let currentRecordId = null;

        async function setMode(mode) {
            currentMode = mode;
            currentPage = 1;
            recordsData = [];

            // Update Buttons UI
            const btnAgencia = document.getElementById('btnAgencia');
            const btnComercio = document.getElementById('btnComercio');

            if (mode === 'agencia') {
                btnAgencia.className = "px-6 py-2 rounded-lg text-sm font-semibold transition-all shadow-sm bg-white text-green-700";
                btnComercio.className = "px-6 py-2 rounded-lg text-sm font-semibold text-gray-500 hover:text-gray-700 transition-all";
            } else {
                btnComercio.className = "px-6 py-2 rounded-lg text-sm font-semibold transition-all shadow-sm bg-white text-blue-700";
                btnAgencia.className = "px-6 py-2 rounded-lg text-sm font-semibold text-gray-500 hover:text-gray-700 transition-all";
            }

            // Load Data
            await loadData();
        }

        async function loadData() {
            isLoading = true;
            updateUIState();

            const apiUrl = currentMode === 'agencia' ? API_URL_AGENCIA : API_URL_COMERCIO;

            try {
                const response = await fetch(`${apiUrl}&page=${currentPage}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                recordsData = Array.isArray(data) ? data : (data.value || []);

            } catch (error) {
                console.error("Error loading data:", error);
                recordsData = [];
                // alert("Hubo un error al cargar los datos."); 
            } finally {
                isLoading = false;
                updateUIState();
                renderTable();
            }
        }

        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage < 1) return;

            currentPage = newPage;
            loadData();
        }

        function updateUIState() {
            const loading = document.getElementById('loading');
            const tableContainer = document.getElementById('tableContainer');
            const emptyState = document.getElementById('emptyState');
            const btnPrev = document.getElementById('btnPrev');
            const pageIndicator = document.getElementById('pageIndicator');
            const btnNext = document.getElementById('btnNext');
            const paginationControls = document.getElementById('paginationControls');

            // Show/Hide Pagination
            paginationControls.classList.remove('hidden');

            pageIndicator.innerText = `P√°gina ${currentPage}`;
            btnPrev.disabled = currentPage <= 1 || isLoading;

            // Assuming 10 items per page
            const hasMore = recordsData.length === 10;
            btnNext.disabled = isLoading || !hasMore;

            if (isLoading) {
                loading.classList.remove('hidden');
                tableContainer.classList.add('hidden');
                emptyState.classList.add('hidden');
            } else {
                loading.classList.add('hidden');
            }
        }

        function renderTable() {
            if (isLoading) return;

            const container = document.getElementById('tableContainer');
            const tbody = document.getElementById('tableBody');
            const theadRow = document.querySelector('thead tr');
            const emptyState = document.getElementById('emptyState');

            // Clear content
            tbody.innerHTML = '';
            theadRow.innerHTML = '';

            if (!recordsData || recordsData.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            } else {
                container.classList.remove('hidden');
                emptyState.classList.add('hidden');
            }

            // Define columns
            let columns = [];

            if (currentMode === 'agencia') {
                columns = [
                    { key: 'fecha_creacion', label: 'Fecha', format: val => formatDate(val) },
                    { key: 'nro_agencia', label: 'Agencia' },
                    { key: 'nro_sucursal', label: 'Sucursal' },
                    { key: 'ocr', label: 'OCR' },
                    { key: 'monto_apuesta', label: 'Monto', format: val => `$${val?.toLocaleString('es-AR')}` },
                    { key: 'validado', label: 'Validado', format: renderStatusBadge },
                    // { key: 'verificado', label: 'Verificado', format: renderStatusBadge },
                    { key: 'actions', label: 'Acciones', format: (val, item) => renderActions(item) }
                ];
            } else {
                columns = [
                    { key: 'fecha_creacion', label: 'Fecha', format: val => formatDate(val) },
                    { key: 'descripcion_empresa', label: 'Empresa' },
                    { key: 'cuit_comercio', label: 'CUIT' },
                    { key: 'numero_ticket_factura', label: 'Comprobante' },
                    { key: 'monto_total_compra', label: 'Monto', format: val => `$${val?.toLocaleString('es-AR')}` },
                    { key: 'validado', label: 'Validado', format: renderStatusBadge },
                    // { key: 'verificado', label: 'Verificado', format: renderStatusBadge },
                    { key: 'actions', label: 'Acciones', format: (val, item) => renderActions(item) }
                ];
            }

            // Render Headers
            columns.forEach(col => {
                const th = document.createElement('th');
                th.className = "pb-3 pl-4 font-semibold text-gray-600";
                th.innerText = col.label;
                theadRow.appendChild(th);
            });

            // Render Rows
            recordsData.forEach(item => {
                // Determine ID (either id_compra or id_agencia)
                const id = currentMode === 'agencia' ? item.id_agencia : item.id_compra;

                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-50 hover:bg-white transition-colors bg-white/50";

                columns.forEach(col => {
                    const td = document.createElement('td');
                    td.className = "py-4 pl-4 text-gray-700 align-middle";

                    if (col.key === 'actions') {
                        td.innerHTML = col.format(null, item);
                    } else {
                        const value = item[col.key];
                        td.innerHTML = col.format ? col.format(value, item) : (value || '-');
                    }

                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
        }

        function renderActions(item) {
            const id = currentMode === 'agencia' ? item.id_agencia : item.id_compra;
            return `
                <button onclick="openModal('${id}')" class="group flex items-center gap-1.5 px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-600 hover:text-white transition-all text-xs font-semibold border border-blue-200 hover:border-blue-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    Ver Detalle
                </button>
             `;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return dateString;
            }
        }

        function renderStatusBadge(status) {
            if (status === 'S' || status === 'YES' || status === true) {
                return '<span class="px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800 border border-green-200">S√ç</span>';
            } else {
                return '<span class="px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-800 border border-red-200">NO</span>';
            }
        }

        // --- Modal Logic ---

        function openModal(id) {
            currentRecordId = id;

            // Find item based on mode
            const idKey = currentMode === 'agencia' ? 'id_agencia' : 'id_compra';
            const item = recordsData.find(d => d[idKey] === id);

            if (!item) return;

            const comercioFields = document.getElementById('comercioFields');
            const agenciaFields = document.getElementById('agenciaFields');
            const fieldTicket = document.getElementById('fieldTicket');
            const fieldPago = document.getElementById('fieldPago');

            if (currentMode === 'agencia') {
                // Show Agency Fields
                comercioFields.classList.add('hidden');
                agenciaFields.classList.remove('hidden');
                fieldTicket.classList.add('hidden'); // No ticket number field in mock for agency, uses OCR
                fieldPago.classList.add('hidden');

                // Populate Agency
                document.getElementById('modalNroAgencia').textContent = item.nro_agencia || '-';
                document.getElementById('modalSucursal').textContent = item.nro_sucursal || '-';
                document.getElementById('modalOCR').textContent = item.ocr || '-';
                document.getElementById('modalMonto').textContent = item.monto_apuesta ? `$${item.monto_apuesta.toLocaleString('es-AR')}` : '-';
                document.getElementById('modalFecha').textContent = formatDate(item.fecha_creacion);

            } else {
                // Show Commerce Fields
                comercioFields.classList.remove('hidden');
                agenciaFields.classList.add('hidden');
                fieldTicket.classList.remove('hidden');
                fieldPago.classList.remove('hidden');

                // Populate Commerce
                document.getElementById('modalEmpresa').textContent = item.descripcion_empresa || '-';
                document.getElementById('modalCuit').textContent = item.cuit_comercio || '-';
                document.getElementById('modalTicket').textContent = item.numero_ticket_factura || '-';
                document.getElementById('modalMonto').textContent = item.monto_total_compra ? `$${item.monto_total_compra.toLocaleString('es-AR')}` : '-';
                document.getElementById('modalFecha').textContent = formatDate(item.fecha_creacion);

                const pagoText = item.medio_pago === 'bancor' ? 'üí≥ Bancor' : (item.medio_pago === 'otros' ? 'üí∞ Otros' : item.medio_pago || '-');
                document.getElementById('modalPago').textContent = pagoText;
            }

            // Image Handling (Reset)
            const imgElement = document.getElementById('modalImage');
            const loadingElement = document.getElementById('imageLoading');
            const noImageElement = document.getElementById('noImage');

            imgElement.classList.add('hidden');
            imgElement.src = '';
            loadingElement.classList.add('hidden');
            noImageElement.classList.add('hidden');

            // Start Fetching Image
            fetchImage(id);

            // Show Modal
            const modal = document.getElementById('detailsModal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        async function fetchImage(id) {
            const noImageElement = document.getElementById('noImage');
            // Mock placeholder since no endpoint was provided for images yet.
            // If real endpoint available:
            // loadingElement.classList.remove('hidden');
            // ... fetch ...

            // Just showing no image for now
            noImageElement.classList.remove('hidden');
        }

        function validateRecord() {
            if (!currentRecordId) return;
            if (confirm('¬øEst√°s seguro que deseas VALIDAR este comprobante?')) {
                console.log('Validating:', currentRecordId, 'Mode:', currentMode);
                alert('Registro validado (Simulacion)');
                closeModal();
            }
        }

        function anularRecord() {
            if (!currentRecordId) return;
            if (confirm('¬øEst√°s seguro que deseas ANULAR este comprobante?')) {
                console.log('Anulando:', currentRecordId, 'Mode:', currentMode);
                alert('Registro anulado (Simulacion)');
                closeModal();
            }
        }

        function closeModal() {
            const modal = document.getElementById('detailsModal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Close on overlay click
        document.getElementById('detailsModal').addEventListener('click', function (e) {
            if (e.target === this) closeModal();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setMode('agencia');
        });

    </script>
</body>

</html>